{% extends "base.html" %}
{% block title %}Settlements{% endblock %}


{% block content %}
{% include 'adjustments/_nav.html' %}
<h3>Settlements</h3>

<input type="file" id="excelFile">
<button id="importBtn" class="btn btn-primary btn-sm">Import</button>
<button id="saveBtn" class="btn btn-success btn-sm">Save All</button>
<a href="{{ url_for('export_settlements') }}" class="btn btn-secondary btn-sm">Export</a>

<table class="table table-striped table-bordered" id="settlementTable">
    <thead>
        <tr>
            <th>Date</th>
            <th>Agent</th>
            <th>Brand</th>
            <th>Amount</th>
            <th>Fee</th>
            <th>Remarks</th>
            <th>MC</th>
            <th>Purpose</th>
            <th>Wallet</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for s in settlements_data %}
        <tr data-id="{{ s.id }}">
            <td contenteditable="true">{{ s.date.strftime("%Y-%m-%d") if s.date else "" }}</td>
            <td contenteditable="true">{{ s.agent }}</td>
            <td contenteditable="true">{{ s.brand }}</td>
            <td contenteditable="true">{{ "{:,.2f}".format(s.amount) }}</td>
            <td contenteditable="true">{{ "{:,.2f}".format(s.fee) }}</td>
            <td contenteditable="true">{{ s.remarks }}</td>
            <td contenteditable="true">{{ s.mc }}</td>
            <td contenteditable="true">{{ s.purpose }}</td>
            <td contenteditable="true">{{ s.wallet }}</td>
            <td>
                <button class="btn btn-sm btn-success save-row">Save</button>
                <button class="btn btn-sm btn-danger delete-row">Delete</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
function parseFloatSafe(v){ return v ? parseFloat(v.toString().replace(/,/g,"")) : 0; }

/* Save All Settlements */
document.getElementById('saveBtn').addEventListener('click', ()=>{
    const rows = document.querySelectorAll('#settlementTable tbody tr');
    const data = [];
    rows.forEach(row=>{
        const cells = row.querySelectorAll('td');
        data.push({
            date: cells[0].innerText.trim(),
            agent: cells[1].innerText.trim(),
            brand: cells[2].innerText.trim(),
            amount: parseFloatSafe(cells[3].innerText),
            fee: parseFloatSafe(cells[4].innerText),
            remarks: cells[5].innerText.trim(),
            mc: cells[6].innerText.trim(),
            purpose: cells[7].innerText.trim(),
            wallet: cells[8].innerText.trim()
        });
    });
    fetch('/settlement/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data})})
    .then(res=>res.json()).then(r=>alert(r.success ? "Saved!" : r.error));
});

/* Row Save/Delete */
document.addEventListener("click", e=>{
    const row = e.target.closest("tr");
    if(!row) return;
    const id = row.dataset.id;

    if(e.target.classList.contains("save-row")){
        const cells = row.querySelectorAll('td');
        const payload = {
            date: cells[0].innerText.trim(),
            agent: cells[1].innerText.trim(),
            brand: cells[2].innerText.trim(),
            amount: parseFloatSafe(cells[3].innerText),
            fee: parseFloatSafe(cells[4].innerText),
            remarks: cells[5].innerText.trim(),
            mc: cells[6].innerText.trim(),
            purpose: cells[7].innerText.trim(),
            wallet: cells[8].innerText.trim()
        };
        fetch(`/settlement/update/${id}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
        .then(res=>res.json()).then(r=>alert(r.success?"Updated!":r.error));
    }

    if(e.target.classList.contains("delete-row")){
        if(!confirm("Delete this settlement?")) return;
        fetch(`/settlement/delete/${id}`,{method:'POST'}).then(res=>res.json()).then(r=>{if(r.success) row.remove(); else alert(r.error)});
    }
});
</script>

{% endblock %}
