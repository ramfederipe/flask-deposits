{% extends "base.html" %}
{% block title %}Daily Balance{% endblock %}

{% block content %}

<nav class="accounts-nav">
    <a href="{{ url_for('accounts_management') }}" class="{% if active_page=='accounts_management' %}active{% endif %}">Accounts Management</a>
    <a href="{{ url_for('monitoring') }}" class="{% if active_page=='monitoring' %}active{% endif %}">Monitoring</a>
    <a href="{{ url_for('overview') }}" class="{% if active_page=='overview' %}active{% endif %}">Overview</a>
    <a href="{{ url_for('wallet_limit') }}" class="{% if active_page=='wallet_limit' %}active{% endif %}">Wallet/Limit</a>
    <a href="{{ url_for('inactive') }}" class="{% if active_page=='inactive' %}active{% endif %}">Inactive</a>
</nav>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<div class="d-flex gap-2 mb-3">
    <a href="{{ url_for('monitoring') }}" class="modern-btn">
        Daily Balance (Today) ‚Üê Back to Monitoring
    </a>
    <a href="{{ url_for('update_opening_balance') }}" class="modern-btn">
        Daily Balance Update Opening Balance
    </a>
</div>

<!-- Server-side Search Form -->
<form method="get" class="mb-3 d-flex gap-2">
    <div>
        <label for="shopSearch">Search Shop:</label>
        <input type="text" id="shopSearch" name="shop_search" class="form-control" placeholder="Type shop name" value="{{ request.args.get('shop_search', '') }}">
    </div>
    <div>
        <label for="groupSearch">Search Group:</label>
        <input type="text" id="groupSearch" name="group_search" class="form-control" placeholder="Type group code" value="{{ request.args.get('group_search', '') }}">
    </div>
    <div style="align-self: flex-end;">
        <button type="submit" class="modern-btn">üîç Search</button>
    </div>
</form>

<a id="exportCsvBtn" class="modern-btn" href="{{ url_for('daily_balance_export_csv', shop_search=request.args.get('shop_search',''), group_search=request.args.get('group_search',''), sort=sort_column, order=sort_order) }}">
    Export CSV
</a>

<table id="dailyBalanceTable" class="table table-striped table-bordered">
    <thead class="table-dark">
        <tr>
            <th>Shop</th>
            <th>Opening Balance</th>
            <th>Deposit (Today)</th>
            <th>Withdrawal (Today)</th>
            <th>Adjustment</th>
            <th>Settlement</th>
            <th>Closing Balance</th>
            <th>SDP</th>
            <th>Group Code</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        {% for data in agents_data %}
        <tr>
            <td>{{ data['shop_name'] }}</td>
            <td>{{ "{:,.2f}".format(data['opening_balance']) }}</td>
            <td>{{ "{:,.2f}".format(data['deposit']) }}</td>
            <td>{{ "{:,.2f}".format(data['withdrawal']) }}</td>
            <td>{{ "{:,.2f}".format(data.get('adjustment', 0)) }}</td>
            <td>{{ "{:,.2f}".format(data.get('settlement', 0)) }}</td>
            <td><strong>{{ "{:,.2f}".format(data['balance']) }}</strong></td>
            <td>{{ "{:,.2f}".format(data.get('sdp', 0)) }}</td>
            <td class="group-code" data-original="{{ data['original_group_code'] }}">{{ data['group_code'] }}</td>
            <td>{{ data['status'] }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Pagination -->
<div class="pagination mt-3">
    {% for p in range(1, total_pages + 1) %}
        <a href="{{ url_for(request.endpoint, page=p, shop_search=request.args.get('shop_search',''), group_search=request.args.get('group_search','')) }}"
           class="{% if p == page %}active{% endif %}">{{ p }}</a>
    {% endfor %}
</div>

<style>
.pagination { display: flex; gap: 5px; justify-content: center; flex-wrap: wrap; }
.pagination a { padding: 5px 10px; border: 1px solid #ccc; text-decoration: none; color: #333; }
.pagination a.active { background-color: #333; color: #fff; }
.pagination a:hover { background-color: #eee; }
</style>

<!-- DataTables Initialization -->
<script>
$(document).ready(function() {
    $('#dailyBalanceTable').DataTable({
        "pageLength": 100,
        "lengthMenu": [50, 100, 200],
        "order": [[0, "asc"]],
        "columnDefs": [
            { "type": "string", "targets": [0, 7, 8] } // SDP & Group columns
        ],
        "dom": 'lrtip' // remove default search input
    });
});
</script>

<script>
$(window).on('scroll', function() {
    if ($(window).scrollTop() > 50) { // adjust threshold
        $('.accounts-nav').addClass('scrolled');
    } else {
        $('.accounts-nav').removeClass('scrolled');
    }
});


</script>

<style>.group-code:hover::after {
    content: " (Original: " attr(data-original) ")";
    color: gray;
    font-size: 12px;
}

</style>
{% endblock %}
